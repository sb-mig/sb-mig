name: Full Test Suite

# Manual trigger from any branch
on:
  workflow_dispatch:
    inputs:
      run_live_tests:
        description: "Run Live API tests"
        required: true
        default: true
        type: boolean
      run_e2e_tests:
        description: "Run E2E tests"
        required: true
        default: true
        type: boolean

env:
  NODE_VERSION: "20.x"

jobs:
  # ============================================================================
  # Job 1: Type Check & Lint
  # ============================================================================
  typecheck-and-lint:
    name: Type Check & Lint
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "yarn"

      - name: Install dependencies
        run: yarn install --frozen-lockfile

      - name: Type Check
        run: yarn typecheck

      - name: Lint
        run: yarn lint

      - name: Prettier Check
        run: yarn prettier --check .

  # ============================================================================
  # Job 2: Build
  # ============================================================================
  build:
    name: Build
    runs-on: ubuntu-latest
    needs: typecheck-and-lint

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "yarn"

      - name: Install dependencies
        run: yarn install --frozen-lockfile

      - name: Build
        run: yarn build

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: dist
          path: dist/
          retention-days: 1

  # ============================================================================
  # Job 3: Unit Tests
  # ============================================================================
  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-latest
    needs: build

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "yarn"

      - name: Install dependencies
        run: yarn install --frozen-lockfile

      - name: Run Unit Tests
        run: yarn test:unit

  # ============================================================================
  # Job 4: Live API Tests
  # ============================================================================
  live-api-tests:
    name: Live API Tests
    runs-on: ubuntu-latest
    needs: unit-tests
    if: ${{ inputs.run_live_tests }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "yarn"

      - name: Install dependencies
        run: yarn install --frozen-lockfile

      - name: Create .env file
        run: |
          echo "STORYBLOK_SPACE_ID=${{ secrets.STORYBLOK_SPACE_ID }}" >> .env
          echo "STORYBLOK_OAUTH_TOKEN=${{ secrets.STORYBLOK_OAUTH_TOKEN }}" >> .env

      - name: Run Live API Tests
        env:
          STORYBLOK_LIVE_TESTS: "true"
          STORYBLOK_SPACE_ID: ${{ secrets.STORYBLOK_SPACE_ID }}
          STORYBLOK_OAUTH_TOKEN: ${{ secrets.STORYBLOK_OAUTH_TOKEN }}
        run: yarn test:api-live

  # ============================================================================
  # Job 5: E2E Tests
  # ============================================================================
  e2e-tests:
    name: E2E Tests
    runs-on: ubuntu-latest
    needs: [unit-tests, live-api-tests]
    # Run if e2e is enabled AND (live-api succeeded OR live-api was skipped)
    if: inputs.run_e2e_tests && (needs.live-api-tests.result == 'success' || needs.live-api-tests.result == 'skipped')

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "yarn"

      - name: Install dependencies
        run: yarn install --frozen-lockfile

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: dist
          path: dist/

      - name: Create .env file
        run: |
          echo "STORYBLOK_SPACE_ID=${{ secrets.STORYBLOK_SPACE_ID }}" >> .env
          echo "STORYBLOK_OAUTH_TOKEN=${{ secrets.STORYBLOK_OAUTH_TOKEN }}" >> .env

      - name: Run E2E Tests
        env:
          STORYBLOK_E2E_TESTS: "true"
          STORYBLOK_SPACE_ID: ${{ secrets.STORYBLOK_SPACE_ID }}
          STORYBLOK_OAUTH_TOKEN: ${{ secrets.STORYBLOK_OAUTH_TOKEN }}
        run: yarn test:e2e

  # ============================================================================
  # Summary Job
  # ============================================================================
  test-summary:
    name: Test Summary
    runs-on: ubuntu-latest
    needs: [typecheck-and-lint, build, unit-tests, live-api-tests, e2e-tests]
    if: always()

    steps:
      - name: Check job results
        run: |
          echo "## Test Suite Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Type Check & Lint | ${{ needs.typecheck-and-lint.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Build | ${{ needs.build.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Unit Tests | ${{ needs.unit-tests.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Live API Tests | ${{ needs.live-api-tests.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| E2E Tests | ${{ needs.e2e-tests.result }} |" >> $GITHUB_STEP_SUMMARY

      - name: Fail if any job failed
        if: |
          needs.typecheck-and-lint.result == 'failure' ||
          needs.build.result == 'failure' ||
          needs.unit-tests.result == 'failure' ||
          needs.live-api-tests.result == 'failure' ||
          needs.e2e-tests.result == 'failure'
        run: exit 1
